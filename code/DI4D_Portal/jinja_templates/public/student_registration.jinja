{% extends "structure/structure_public.jinja" %}

{% block title %}Student Registration - DI4D Portal{% endblock %}

{% block content %}
<div class="w-full bg-[var(--blue_di4d)] min-h-screen py-12 px-6 lg:px-20">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-12">
            <h1 class="text-4xl font-bold text-white mb-4">Student Registration</h1>
            <p class="text-white text-lg">You can do this student registration to apply for Digital Innovation. After you fill this out we will check your information. If you get this nice chance to do this we will contact you.

Fill in as much as possible. Good luck!</p>
        </div>

        <!-- Registration Status Messages -->
        {% if registration_closed %}
        <div class="bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-amber-500 rounded-lg shadow-lg p-8 mb-8">
            <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                    <svg class="w-8 h-8 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-amber-900 mb-2">Registration Currently Closed</h2>
                    <p class="text-amber-800 text-base mb-4">The registration period is currently closed. Please check back during the next registration window to submit your application.</p>
                    <p class="text-amber-700 text-sm italic">If you have any questions, please contact our support team.</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if success %}
        <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-8">
            <div class="flex items-start gap-4">
                <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <div>
                    <h3 class="font-semibold text-green-800">Success!</h3>
                    <p class="text-green-700 mt-1">{{ success }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if error %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
            <div class="flex items-start gap-4">
                <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <div>
                    <h3 class="font-semibold text-red-800">Error</h3>
                    <p class="text-red-700 mt-1">{{ error }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Form -->
        {% if registration_open and questions %}
        <div id="registration-form-container">
            <form method="POST" enctype="multipart/form-data" hx-post="{{ url('student_registration') }}" hx-target="#registration-form-container" hx-encoding="multipart/form-data" class="bg-[var(--blue_di4d)] rounded-lg shadow-md p-8 space-y-8" id="registration-form">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

            {% for question in questions %}
            <div class="form-group border-b border-gray-200 pb-8 last:border-b-0" id="question-group-{{ question.id }}">
                <!-- Question Label with Mandatory Indicator -->
                <div class="flex items-baseline gap-2 mb-3">
                    <label class="block text-lg font-medium text-white">
                        {{ question.question }}
                    </label>
                    {% if question.isMandatory %}
                    <span class="text-red-500 font-bold text-sm" title="This field is mandatory">*</span>
                    {% endif %}
                </div>
                {% if errors and ('question_' ~ question.id) in errors %}
                <div class="bg-red-600 border border-red-700 text-white px-3 py-2 rounded-md text-sm mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-exclamation-circle flex-shrink-0"></i>
                    <span>{{ errors['question_' ~ question.id] }}</span>
                </div>
                {% endif %}

                <!-- Form Input Based on DataType -->
                {% if loop.last %}
                {# Last question: File Upload with Drag and Drop #}
                <div class="mt-4 bg-white">
                    <div class="relative">
                        <input 
                            type="file" 
                            id="question_{{ question.id }}_file" 
                            name="question_{{ question.id }}_file"
                            class="hidden"
                            {% if question.isMandatory %}required{% endif %}
                            accept=".pdf,.doc,.docx,.xls,.xlsx,.zip,.jpg,.jpeg,.png,.txt"
                        />
                        
                        <div id="dropzone" 
                             class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-di4d hover:bg-blue-50 transition-all bg-white"
                             ondrop="handleDrop(event, 'question_{{ question.id }}_file')"
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(event)"
                             onclick="document.getElementById('question_{{ question.id }}_file').click()">
                            
                            <i class="fa-solid fa-cloud-arrow-up text-gray-400 text-2xl mb-2"></i>
                            
                            <p class="text-gray-700 text-sm">
                                Drag & Drop or <span class="text-orange-di4d font-medium">Choose file</span> to upload
                            </p>
                        </div>

                        <!-- File Preview -->
                        <div id="file_preview_{{ question.id }}" class="mt-4 hidden">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd" />
                                    </svg>
                                    <div>
                                        <p class="font-medium text-gray-900" id="file_name_{{ question.id }}"></p>
                                        <p class="text-sm text-gray-500" id="file_size_{{ question.id }}"></p>
                                    </div>
                                </div>
                                <button type="button" class="text-red-600 hover:text-red-800" onclick="clearFile('question_{{ question.id }}_file', 'file_preview_{{ question.id }}')">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                {% else %}
                {% if question.question|length > 12 %}
                    {# Larger textarea for longer questions #}
                    <textarea
                        id="question_{{ question.id }}"
                        name="question_{{ question.id }}"
                        class="w-full px-4 py-4 border border-gray-300 bg-white rounded-lg focus:ring-2 focus:ring-blue-di4d focus:border-transparent outline-none transition resize-none"
                        rows="6"
                        placeholder="{% if question.explanation %}{{ question.explanation }}{% else %}Enter your answer...{% endif %}"
                        {% if question.isMandatory %}required{% endif %}
                    ></textarea>
                {% else %}
                    {# Regular input for shorter questions #}
                    <input 
                        type="text"
                        id="question_{{ question.id }}"
                        name="question_{{ question.id }}"
                        class="w-full px-4 py-3 border border-gray-300 bg-white rounded-lg focus:ring-2 focus:ring-blue-di4d focus:border-transparent outline-none transition"
                        placeholder="{% if question.explanation %}{{ question.explanation }}{% else %}Enter your answer...{% endif %}"
                        {% if question.isMandatory %}required{% endif %}
                    />
                {% endif %}
                {% endif %}
            </div>
            {% endfor %}

            <!-- Submit Button -->
            <div class="pt-8 border-t border-gray-200">
                <button 
                    type="submit"
                    class="w-auto px-8 btn_primary_orange py-3 rounded-lg font-semibold text-white hover:opacity-90 transition"
                >
                    Send Student Registration
                </button>
            </div>
            </form>
        </div>
        {% elif not registration_closed %}
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
            <p class="text-gray-600 text-lg">No questions available for this form.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Drag and drop handling
    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.add('border-blue-di4d', 'bg-blue-50');
    }

    function handleDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.remove('border-blue-di4d', 'bg-blue-50');
    }

    function handleDrop(event, fileInputId) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.remove('border-blue-di4d', 'bg-blue-50');
        
        const files = event.dataTransfer.files;
        const fileInput = document.getElementById(fileInputId);
        
        if (files.length > 0) {
            fileInput.files = files;
            updateFilePreview(fileInputId);
        }
    }

    // Update file preview when file is selected
    document.addEventListener('change', function(event) {
        if (event.target.type === 'file') {
            updateFilePreview(event.target.id);
        }
    });

    function updateFilePreview(fileInputId) {
        const fileInput = document.getElementById(fileInputId);
        const questionId = fileInputId.replace('question_', '').replace('_file', '');
        const previewDiv = document.getElementById(`file_preview_${questionId}`);
        
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            document.getElementById(`file_name_${questionId}`).textContent = file.name;
            document.getElementById(`file_size_${questionId}`).textContent = formatFileSize(file.size);
            previewDiv.classList.remove('hidden');
        } else {
            previewDiv.classList.add('hidden');
        }
    }

    function clearFile(fileInputId, previewId) {
        const fileInput = document.getElementById(fileInputId);
        fileInput.value = '';
        document.getElementById(previewId).classList.add('hidden');
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
</script>
{% endblock %}
