name: Run command on remote server
on:
  push:
    branches:
      - testing
    
jobs:
  ssh_command:
    # if: github.event.pull_request.merged == true
    name: Run SSH command
    environment: testing
    runs-on: ubuntu-latest
    steps:
      - name: Save SSH private key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY_VALUE }}" > ${{ secrets.SSH_PRIVATE_KEY_FILENAME }}
          chmod 600 ${{ secrets.SSH_PRIVATE_KEY_FILENAME }}
      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
      - name: Run remote command via SSH
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ProxyCommand="cloudflared access ssh --hostname %h --service-token-id ${{ secrets.CF_ACCESS_CLIENT_ID }} --service-token-secret ${{ secrets.CF_ACCESS_CLIENT_SECRET }}" \
              -i ${{ secrets.SSH_PRIVATE_KEY_FILENAME }} \
              ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
              "mkdir -v hello-world"