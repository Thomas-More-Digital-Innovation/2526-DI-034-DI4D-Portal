name: Run command on remote server
on:
  push:
    branches:
      - testing
jobs:
  ssh_command:
    # if: github.event.pull_request.merged == true
    name: Run SSH command
    environment: testing
    # needs: terraform_apply
    runs-on: ubuntu-latest
    steps:
      - name: Install cloudflared
        shell: bash
        run: |
          set -euo pipefail
          sudo curl -fsSL \
            https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 \
            -o /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
          cloudflared --version

      - name: Configure SSH key
        shell: bash
        env:
          SSH_PRIVATE_KEY_B64: ${{ secrets.SSH_PRIVATE_KEY_B64 }}
        run: |
          set -euo pipefail
          install -d -m 700 ~/.ssh
          if [ -z "${SSH_PRIVATE_KEY_B64:-}" ]; then
            echo "Missing secret SSH_PRIVATE_KEY_B64 (base64-encoded private key)" >&2
            exit 1
          fi

          echo "$SSH_PRIVATE_KEY_B64" | base64 -d > ~/.ssh/id_deploy

          chmod 600 ~/.ssh/id_deploy

          # Fail fast with a helpful error if the key can't be parsed.
          ssh-keygen -y -f ~/.ssh/id_deploy >/dev/null

      - name: Connect and run command on remote server
        shell: bash
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          set -euo pipefail

          ssh \
            -i ~/.ssh/id_deploy \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ProxyCommand="cloudflared access ssh --hostname %h" \
            -p "$SSH_PORT" \
            "$SSH_USERNAME@$SSH_HOST" \
            "mkdir hello-world -v"